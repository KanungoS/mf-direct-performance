name: Daily MF Grid + Portfolio Update

on:
  schedule:
    - cron: "0 3 * * *"    # Runs daily at 08:30 AM IST (03:00 UTC)
  workflow_dispatch:

jobs:
  update-mf-data:
    runs-on: ubuntu-latest

    steps:
    # ----------------------------------------------------
    # CHECKOUT REPO
    # ----------------------------------------------------
    - name: Checkout repository
      uses: actions/checkout@v3

    # ----------------------------------------------------
    # PYTHON SETUP
    # ----------------------------------------------------
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.12"

    # ----------------------------------------------------
    # INSTALL DEPENDENCIES
    # ----------------------------------------------------
    - name: Install dependencies
      run: |
        pip install -r requirements.txt

    # ----------------------------------------------------
    # RUN MAIN ENGINE
    # ----------------------------------------------------
    - name: Run MF Grid + Portfolio Engine
      run: |
        python scripts/generate_grid.py

    # ----------------------------------------------------
    # COMMIT UPDATED FILES BACK TO REPO
    # ----------------------------------------------------
    - name: Commit updated files
      run: |
        git config --global user.email "actions@github.com"
        git config --global user.name "github-actions"
        git add data/*.csv
        git add data/*.xlsx
        git commit -m "Daily update $(date)" || echo "No changes to commit"
        git push

    # ----------------------------------------------------
    # SEND DAILY REPORT EMAIL (ATTACH EXCEL)
    # ----------------------------------------------------
    - name: Send MF Report Email
      env:
        GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
      run: |
        sudo apt-get update
        sudo apt-get install -y mailutils mutt

        echo "Please find attached today's Mutual Fund Grid & Portfolio Tracker." > message.txt

        mutt \
          -e "set from=yourgmail@gmail.com" \
          -e "set realname='MF Daily Automation'" \
          -e "set smtp_url=smtps://yourgmail@gmail.com:${GMAIL_APP_PASSWORD}@smtp.gmail.com:465" \
          -s "Daily MF Update - $(date)" \
          -a data/mf_direct_grid.xlsx -- yourgmail@gmail.com < message.txt

    # ----------------------------------------------------
    # SEND ALERT IF ANY FUND DROPS >5%
    # ----------------------------------------------------
    - name: Send Drop Alert Email
      env:
        GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
      run: |
        python3 << 'EOF'
import pandas as pd
import smtplib
from email.message import EmailMessage
import os

df = pd.read_csv("data/my_portfolio.csv")

# Filter: deviation <= -5%
alerts = df[df["% Deviation"] <= -5]

if alerts.empty:
    print("No negative alerts today.")
    exit(0)

msg = EmailMessage()
msg["Subject"] = "⚠ MF Alert — NAV Drop Exceeded 5%"
msg["From"] = "yourgmail@gmail.com"
msg["To"] = "yourgmail@gmail.com"

body = "⚠ ALERT — The following funds have dropped more than 5%:\n\n"
for _, r in alerts.iterrows():
    body += f"{r['Scheme Name']}  →  {r['% Deviation']:.2f}%\n"

msg.set_content(body)

smtp = smtplib.SMTP_SSL("smtp.gmail.com", 465)
smtp.login("yourgmail@gmail.com", os.environ["GMAIL_APP_PASSWORD"])
smtp.send_message(msg)
smtp.quit()

print("Alert email sent.")
EOF
