name: Daily MF Grid + Portfolio Update

on:
  schedule:
    - cron: "0 3 * * *"    # 08:30 AM IST (03:00 UTC)
  workflow_dispatch:

jobs:
  update-mf-data:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.12"

    - name: Install dependencies
      run: |
        pip install -r requirements.txt

    - name: Run MF Grid + Portfolio Engine
      run: |
        python scripts/generate_grid.py

    - name: Commit updated files
      run: |
        git config --global user.email "actions@github.com"
        git config --global user.name "github-actions"
        git add data/*.csv
        git add data/*.xlsx
        git commit -m "Daily update $(date)" || echo "No changes"
        git push

    # ----------------------------------------------------
    # EMAIL FINAL REPORT
    # ----------------------------------------------------
    - name: Send MF Report Email
      env:
        GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
      run: |
        sudo apt-get update
        sudo apt-get install -y mailutils mutt

        echo "Please find attached today's Mutual Fund Grid & Portfolio Tracker." > message.txt

        mutt \
          -e "set from=yourgmail@gmail.com" \
          -e "set realname='MF Daily Automation'" \
          -e "set smtp_url=smtps://yourgmail@gmail.com:${GMAIL_APP_PASSWORD}@smtp.gmail.com:465" \
          -s "Daily MF Update - $(date)" \
          -a data/mf_direct_grid.xlsx -- yourgmail@gmail.com < message.txt

    # ----------------------------------------------------
    # SEND ALERT IF ANY FUND DROPS >5%
    # ----------------------------------------------------
    - name: Send Drop Alert Email
      env:
        GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
      run: |
        python3 - << 'EOF'
import pandas as pd
import smtplib
from email.mime.text import MIMEText

df = pd.read_csv("data/my_portfolio.csv")

alerts = df[df["% Deviation"] <= -5]
if alerts.empty:
    print("No negative alerts.")
    exit(0)

msg = "⚠ ALERT — The following funds have dropped more than 5%:\n\n"
for _, r in alerts.iterrows():
    msg += f"{r['Scheme Name']}: {r['% Deviation']:.2f}%\n"

email = "yourgmail@gmail.com"
app_pw = "${{ secrets.GMAIL_APP_PASSWORD }}"

mime = MIMEText(msg)
mime["Subject"] = "⚠ MF Alert — NAV Drop Exceeded 5%"
mime["From"] = email
mime["To"] = email

with smtplib.SMTP_SSL("smtp.gmail.com", 465) as smtp:
    smtp.login(email, app_pw)
    smtp.sendmail(email, email, mime.as_string())

print("Alert email sent.")
EOF
# refresh workflow
