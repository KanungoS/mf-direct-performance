name: "Daily MF Grid and Portfolio Update"

on:
  schedule:
    - cron: "0 3 * * *"   # 08:30 AM IST
  workflow_dispatch:

jobs:
  run-engine:
    runs-on: ubuntu-latest

    steps:
      # -----------------------------
      # CHECKOUT REPOSITORY
      # -----------------------------
      - name: Checkout repository
        uses: actions/checkout@v3

      # -----------------------------
      # SET UP PYTHON
      # -----------------------------
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.12"

      # -----------------------------
      # INSTALL DEPENDENCIES
      # -----------------------------
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      # -----------------------------
      # RUN MAIN MF ENGINE
      # -----------------------------
      - name: Run MF Grid and Portfolio Engine
        run: |
          python scripts/generate_grid.py

      # -----------------------------
      # COMMIT UPDATED FILES
      # -----------------------------
      - name: Commit updated output files
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"
          git add data/*.csv || true
          git add data/*.xlsx || true
          git commit -m "Daily update $(date)" || echo "No changes to commit"
          git push

      # -----------------------------
      # EMAIL DAILY REPORT (ATTACHMENTS)
      # -----------------------------
      - name: Email Daily MF Report
        env:
          GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
        run: |
          sudo apt-get update
          sudo apt-get install -y mutt mailutils

          echo "Attached is today's MF Grid + Portfolio Auto-Report." > message.txt

          mutt \
            -e "set from=sumitkanungo63@gmail.com" \
            -e "set realname='MF Daily Automation'" \
            -e "set smtp_url=smtps://sumitkanungo63@gmail.com:${GMAIL_APP_PASSWORD}@smtp.gmail.com:465" \
            -s "Daily MF Update - $(date)" \
            -a data/mf_direct_grid.xlsx \
            -a data/my_portfolio.csv \
            -- sumitkanungo63@gmail.com < message.txt

      # -----------------------------
      # SEND ALERT IF FUND DROPS >5%
      # -----------------------------
      - name: Send Drop Alert Email
        env:
          GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
        run: |
          python3 << 'EOF'
          import os
          import pandas as pd
          import smtplib
          from email.message import EmailMessage

          df = pd.read_csv("data/my_portfolio.csv")

          if "% Deviation" not in df.columns:
              print("No % Deviation column found.")
              raise SystemExit(0)

          alerts = df[df["% Deviation"] <= -5]

          if alerts.empty:
              print("No alerts to send.")
              raise SystemExit(0)

          body = "⚠ ALERT — Funds dropped more than 5%:\n\n"
          for _, row in alerts.iterrows():
              body += f"{row['Scheme Name']} → {row['% Deviation']:.2f}%\n"

          email = "sumitkanungo63@gmail.com"
          app_pw = os.environ["GMAIL_APP_PASSWORD"]

          msg = EmailMessage()
          msg["Subject"] = "⚠ MF Alert — Drop >5%"
          msg["From"] = email
          msg["To"] = email
          msg.set_content(body)

          with smtplib.SMTP_SSL("smtp.gmail.com", 465) as smtp:
              smtp.login(email, app_pw)
              smtp.send_message(msg)

          print("Alert email sent.")
          EOF
