name: "Daily MF Grid and Portfolio Update"

on:
  schedule:
    - cron: "0 3 * * *"   # 08:30 AM IST
  workflow_dispatch:

jobs:
  run-engine:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run MF Grid and Portfolio Engine
        run: |
          python scripts/generate_grid.py

      - name: Commit updated output files
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"
          git add data/*.csv data/*.xlsx || true
          git commit -m "Daily MF update $(date)" || echo "No changes"
          git push

      # -----------------------------
      # EMAIL REPORT (PYTHON ONLY)
      # -----------------------------
      - name: Email Daily MF Report
        env:
          GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
        run: |
          python3 << 'EOF'
          import os, smtplib
          from email.message import EmailMessage

          email = "sumitkanungo63@gmail.com"
          app_pw = os.environ["GMAIL_APP_PASSWORD"]

          msg = EmailMessage()
          msg["Subject"] = "Daily MF Grid & Portfolio Update"
          msg["From"] = email
          msg["To"] = email
          msg.set_content("Attached is today's MF Grid and Portfolio report.")

          for f in ["data/mf_direct_grid.xlsx", "data/my_portfolio.csv"]:
              try:
                  with open(f, "rb") as file:
                      msg.add_attachment(
                          file.read(),
                          maintype="application",
                          subtype="octet-stream",
                          filename=f.split("/")[-1]
                      )
              except FileNotFoundError:
                  pass

          with smtplib.SMTP_SSL("smtp.gmail.com", 465) as smtp:
              smtp.login(email, app_pw)
              smtp.send_message(msg)

          print("Daily report email sent.")
          EOF

      # -----------------------------
      # DROP ALERT EMAIL
      # -----------------------------
      - name: Send Drop Alert Email
        env:
          GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
        run: |
          python3 << 'EOF'
          import os, pandas as pd, smtplib
          from email.message import EmailMessage

          df = pd.read_csv("data/my_portfolio.csv")
          alerts = df[df["% Deviation"] <= -5]

          if alerts.empty:
              print("No alerts.")
              exit(0)

          body = "ALERT: Funds dropped more than 5%\n\n"
          for _, r in alerts.iterrows():
              body += f"{r['Scheme Name']} → {r['% Deviation']:.2f}%\n"

          email = "sumitkanungo63@gmail.com"
          app_pw = os.environ["GMAIL_APP_PASSWORD"]

          msg = EmailMessage()
          msg["Subject"] = "MF Alert – Drop >5%"
          msg["From"] = email
          msg["To"] = email
          msg.set_content(body)

          with smtplib.SMTP_SSL("smtp.gmail.com", 465) as smtp:
              smtp.login(email, app_pw)
              smtp.send_message(msg)

          print("Alert email sent.")
          EOF
