name: Daily MF Grid + Portfolio Update

on:
  schedule:
    - cron: "0 3 * * *"
  workflow_dispatch:

jobs:
  run-engine:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.12"

    - name: Install dependencies
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run MF Grid + Portfolio Engine
      run: |
        python scripts/generate_grid.py

    - name: Commit updated output files
      run: |
        git config --global user.name "github-actions"
        git config --global user.email "actions@github.com"
        git add data/*.csv || true
        git add data/*.xlsx || true
        git commit -m "Daily update $(date)" || echo "No changes"
        git push

    - name: Email Daily MF Report
      env:
        GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
      run: |
        sudo apt-get update
        sudo apt-get install -y mutt mailutils

        echo "Attached is today's MF grid and portfolio tracker." > message.txt

        mutt \
          -e "set from=sumitkanungo63@gmail.com" \
          -e "set realname='MF Daily Automation'" \
          -e "set smtp_url=smtps://sumitkanungo63@gmail.com:${GMAIL_APP_PASSWORD}@smtp.gmail.com:465" \
          -s "Daily MF Update - $(date)" \
          -a data/mf_direct_grid.xlsx \
          -- sumitkanungo63@gmail.com < message.txt

    - name: Send Drop Alert Email
      env:
        GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
      run: |
        python3 << 'EOF'
import os
import pandas as pd
import smtplib
from email.message import EmailMessage

PORTFOLIO_FILE = "data/my_portfolio.csv"
email = "sumitkanungo63@gmail.com"
app_pw = os.environ["GMAIL_APP_PASSWORD"]

df = pd.read_csv(PORTFOLIO_FILE)

alerts = df[df["% Deviation"] <= -5]

if alerts.empty:
    print("No alerts to send.")
    raise SystemExit(0)

body = "ALERT: The following funds dropped more than 5 percent:\n\n"
for _, row in alerts.iterrows():
    body += f"{row['Scheme Name']} : {row['% Deviation']:.2f}%\n"

msg = EmailMessage()
msg["Subject"] = "MF Alert - NAV Drop >5%"
msg["From"] = email
msg["To"] = email
msg.set_content(body)

with smtplib.SMTP_SSL("smtp.gmail.com", 465) as smtp:
    smtp.login(email, app_pw)
    smtp.send_message(msg)

print("Alert email sent.")
EOF

